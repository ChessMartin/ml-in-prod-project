name: CI/CD Pipeline for Staging

on:
  push:
    branches:
      - staging

jobs:
  sonarcloud-flask:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: SonarCloud Scan
      uses: sonarsource/sonarcloud-github-action@master
      with:
        projectBaseDir: ./flask-api-ml
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  
  sonarcloud-streamlit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: SonarCloud Scan
      uses: sonarsource/sonarcloud-github-action@master
      with:
        projectBaseDir: ./streamlit_app
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  test-docker-compose:
    needs: [sonarcloud-flask, sonarcloud-streamlit]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Docker Compose
        run: docker-compose -f docker-compose.yml up -d
      - name: Shutdown Docker Compose
        run: docker-compose down

  create-pull-request:
    needs: test-docker-compose
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: staging

      - name: Check for Existing Pull Request
        id: check-pr
        run: |
          PR_EXISTS=$(curl -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls?state=open&head=${GITHUB_REPOSITORY_OWNER}:staging&base=main" | jq '. | length > 0')
          echo "PR_EXISTS=${PR_EXISTS}" >> $GITHUB_ENV

      - name: Create Pull Request if Not Exists
        if: env.PR_EXISTS == 'false'
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: "Merge staging into main"
          branch: merge-staging-to-main-${{ github.run_number }}
          title: "Merge staging into main"
          body: "This pull request is auto-generated by GitHub Actions."
          base: main
          labels: |
            automated pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        